<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ZCreate Registry World - Mobile Fixed</title>
  <style>
    body { 
      margin: 0; 
      overflow: hidden; 
      font-family: Arial, sans-serif;
      touch-action: none;
    }
    #controls-info {
      position: absolute;
      bottom: 20px;
      left: 0;
      right: 0;
      text-align: center;
      color: white;
      background: rgba(0,0,0,0.5);
      padding: 8px;
      font-size: 14px;
      pointer-events: none;
      z-index: 10;
    }
    #joystick-area {
      position: absolute;
      bottom: 30px;
      left: 30px;
      width: 120px;
      height: 120px;
      background: rgba(255,255,255,0.2);
      border-radius: 60px;
      backdrop-filter: blur(5px);
      border: 2px solid rgba(255,255,255,0.3);
      z-index: 20;
      touch-action: none;
      pointer-events: auto;
    }
    #joystick-handle {
      position: absolute;
      width: 50px;
      height: 50px;
      background: rgba(255,255,255,0.8);
      border-radius: 25px;
      top: 35px;
      left: 35px;
      touch-action: none;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      pointer-events: none;
    }
    #flight-buttons {
      position: absolute;
      bottom: 30px;
      right: 30px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      z-index: 20;
      pointer-events: auto;
    }
    .flight-btn {
      width: 70px;
      height: 70px;
      background: rgba(0,0,0,0.6);
      border: 2px solid rgba(255,255,255,0.5);
      border-radius: 35px;
      color: white;
      font-size: 24px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
      user-select: none;
      touch-action: manipulation;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      pointer-events: auto;
    }
    .flight-btn:active {
      background: rgba(100,100,255,0.8);
      transform: scale(0.95);
    }
    canvas {
      touch-action: none;
      display: block;
    }
  </style>
</head>
<body>
  <div id="controls-info">üëÜ –õ–µ–≤–æ–π —Ä—É–∫–æ–π –¥–∂–æ–π—Å—Ç–∏–∫ | –ü—Ä–∞–≤–æ–π —Ä—É–∫–æ–π –∫–Ω–æ–ø–∫–∏ | –ü—Ä–∞–≤–æ–π —Ä—É–∫–æ–π –ø–æ–≤–æ—Ä–æ—Ç —ç–∫—Ä–∞–Ω–∞</div>
  
  <div id="joystick-area">
    <div id="joystick-handle"></div>
  </div>
  
  <div id="flight-buttons">
    <div class="flight-btn" id="btn-up">‚¨ÜÔ∏è</div>
    <div class="flight-btn" id="btn-down">‚¨áÔ∏è</div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <script>
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.body.appendChild(renderer.domElement);

    camera.position.set(15, 10, 15);
    
    // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ---
    const controlState = {
      // –ö–ª–∞–≤–∏—à–∏ (–¥–ª—è –ü–ö)
      w: false, a: false, s: false, d: false,
      q: false, e: false, shift: false, space: false,
      
      // –ú–æ–±–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
      moveX: 0,
      moveY: 0,
      moveForward: 0,
      moveRight: 0,
      flyUp: false,
      flyDown: false,
      
      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–∞—Å–∞–Ω–∏–π
      joystickTouchId: null,
      cameraTouchId: null
    };

    // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à (–¥–ª—è –ü–ö) ---
    window.addEventListener('keydown', (e) => {
      switch(e.code) {
        case 'KeyW': controlState.w = true; e.preventDefault(); break;
        case 'KeyA': controlState.a = true; e.preventDefault(); break;
        case 'KeyS': controlState.s = true; e.preventDefault(); break;
        case 'KeyD': controlState.d = true; e.preventDefault(); break;
        case 'KeyQ': controlState.q = true; e.preventDefault(); break;
        case 'KeyE': controlState.e = true; e.preventDefault(); break;
        case 'ShiftLeft': controlState.shift = true; e.preventDefault(); break;
        case 'Space': controlState.space = true; e.preventDefault(); break;
      }
    });

    window.addEventListener('keyup', (e) => {
      switch(e.code) {
        case 'KeyW': controlState.w = false; e.preventDefault(); break;
        case 'KeyA': controlState.a = false; e.preventDefault(); break;
        case 'KeyS': controlState.s = false; e.preventDefault(); break;
        case 'KeyD': controlState.d = false; e.preventDefault(); break;
        case 'KeyQ': controlState.q = false; e.preventDefault(); break;
        case 'KeyE': controlState.e = false; e.preventDefault(); break;
        case 'ShiftLeft': controlState.shift = false; e.preventDefault(); break;
        case 'Space': controlState.space = false; e.preventDefault(); break;
      }
    });

    // --- –ú–æ–±–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –¥–∂–æ–π—Å—Ç–∏–∫ ---
    const joystickArea = document.getElementById('joystick-area');
    const joystickHandle = document.getElementById('joystick-handle');
    const joystickMaxDist = 40;

    function handleJoystickStart(e) {
      e.preventDefault();
      const touch = e.touches[0];
      controlState.joystickTouchId = touch.identifier;
      joystickActive = true;
    }

    function handleJoystickMove(e) {
      e.preventDefault();
      
      // –ù–∞—Ö–æ–¥–∏–º –Ω—É–∂–Ω–æ–µ –∫–∞—Å–∞–Ω–∏–µ
      let touch = null;
      for (let i = 0; i < e.touches.length; i++) {
        if (e.touches[i].identifier === controlState.joystickTouchId) {
          touch = e.touches[i];
          break;
        }
      }
      
      if (!touch) return;
      
      const rect = joystickArea.getBoundingClientRect();
      const centerX = rect.left + rect.width/2;
      const centerY = rect.top + rect.height/2;
      
      let deltaX = touch.clientX - centerX;
      let deltaY = touch.clientY - centerY;
      
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
      const dist = Math.sqrt(deltaX*deltaX + deltaY*deltaY);
      if (dist > joystickMaxDist) {
        deltaX = (deltaX / dist) * joystickMaxDist;
        deltaY = (deltaY / dist) * joystickMaxDist;
      }
      
      // –ü–æ–∑–∏—Ü–∏—è —Ä—É—á–∫–∏
      joystickHandle.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
      
      // –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è
      controlState.moveX = deltaX / joystickMaxDist;
      controlState.moveY = deltaY / joystickMaxDist;
      
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è: –≤–ø–µ—Ä–µ–¥/–Ω–∞–∑–∞–¥ (Y), –≤–ø—Ä–∞–≤–æ/–≤–ª–µ–≤–æ (X)
      controlState.moveForward = -controlState.moveY;
      controlState.moveRight = controlState.moveX;
    }

    function handleJoystickEnd(e) {
      e.preventDefault();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –ª–∏ –∫–∞—Å–∞–Ω–∏–π —Å —ç—Ç–∏–º id
      let touchStillExists = false;
      for (let i = 0; i < e.touches.length; i++) {
        if (e.touches[i].identifier === controlState.joystickTouchId) {
          touchStillExists = true;
          break;
        }
      }
      
      if (!touchStillExists) {
        controlState.joystickTouchId = null;
        joystickHandle.style.transform = 'translate(0px, 0px)';
        controlState.moveX = 0;
        controlState.moveY = 0;
        controlState.moveForward = 0;
        controlState.moveRight = 0;
      }
    }

    joystickArea.addEventListener('touchstart', handleJoystickStart, { passive: false });
    joystickArea.addEventListener('touchmove', handleJoystickMove, { passive: false });
    joystickArea.addEventListener('touchend', handleJoystickEnd, { passive: false });
    joystickArea.addEventListener('touchcancel', handleJoystickEnd, { passive: false });

    // --- –ú–æ–±–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –∫–Ω–æ–ø–∫–∏ –ø–æ–ª–µ—Ç–∞ ---
    document.getElementById('btn-up').addEventListener('touchstart', (e) => {
      e.preventDefault();
      e.stopPropagation();
      controlState.flyUp = true;
    });
    document.getElementById('btn-up').addEventListener('touchend', (e) => {
      e.preventDefault();
      e.stopPropagation();
      controlState.flyUp = false;
    });
    document.getElementById('btn-up').addEventListener('touchcancel', (e) => {
      e.preventDefault();
      e.stopPropagation();
      controlState.flyUp = false;
    });

    document.getElementById('btn-down').addEventListener('touchstart', (e) => {
      e.preventDefault();
      e.stopPropagation();
      controlState.flyDown = true;
    });
    document.getElementById('btn-down').addEventListener('touchend', (e) => {
      e.preventDefault();
      e.stopPropagation();
      controlState.flyDown = false;
    });
    document.getElementById('btn-down').addEventListener('touchcancel', (e) => {
      e.preventDefault();
      e.stopPropagation();
      controlState.flyDown = false;
    });

    // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∑–≥–ª—è–¥–æ–º —á–µ—Ä–µ–∑ –∫–∞—Å–∞–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞ (–ù–ï –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—è –¥–∂–æ–π—Å—Ç–∏–∫) ---
    let pitch = 0;
    let yaw = 0;
    const touchSensitivity = 0.005;
    let lastTouchX = null;
    let lastTouchY = null;

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞—Å–∞–Ω–∏—è –Ω–∞ canvas –¥–ª—è –ø–æ–≤–æ—Ä–æ—Ç–∞ –∫–∞–º–µ—Ä—ã
    renderer.domElement.addEventListener('touchstart', (e) => {
      // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º, –µ—Å–ª–∏ –∫–∞—Å–∞–Ω–∏–µ –Ω–∞—á–∞–ª–æ—Å—å –Ω–∞ –¥–∂–æ–π—Å—Ç–∏–∫–µ –∏–ª–∏ –∫–Ω–æ–ø–∫–∞—Ö
      const touch = e.touches[0];
      const element = document.elementFromPoint(touch.clientX, touch.clientY);
      
      if (element === joystickArea || element.closest('#flight-buttons')) {
        return;
      }
      
      e.preventDefault();
      
      if (e.touches.length === 1) {
        controlState.cameraTouchId = touch.identifier;
        lastTouchX = touch.clientX;
        lastTouchY = touch.clientY;
      }
    });

    renderer.domElement.addEventListener('touchmove', (e) => {
      // –ù–∞—Ö–æ–¥–∏–º –∫–∞—Å–∞–Ω–∏–µ –¥–ª—è –∫–∞–º–µ—Ä—ã
      let touch = null;
      for (let i = 0; i < e.touches.length; i++) {
        if (e.touches[i].identifier === controlState.cameraTouchId) {
          touch = e.touches[i];
          break;
        }
      }
      
      if (!touch || lastTouchX === null || lastTouchY === null) return;
      
      e.preventDefault();
      
      const deltaX = touch.clientX - lastTouchX;
      const deltaY = touch.clientY - lastTouchY;
      
      yaw -= deltaX * touchSensitivity;
      pitch -= deltaY * touchSensitivity;
      
      pitch = Math.max(-Math.PI/2, Math.min(Math.PI/2, pitch));
      
      camera.rotation.order = 'YXZ';
      camera.rotation.set(pitch, yaw, 0);
      
      lastTouchX = touch.clientX;
      lastTouchY = touch.clientY;
    });

    renderer.domElement.addEventListener('touchend', (e) => {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å –ª–∏ –∫–∞—Å–∞–Ω–∏–µ –∫–∞–º–µ—Ä—ã
      let touchStillExists = false;
      for (let i = 0; i < e.touches.length; i++) {
        if (e.touches[i].identifier === controlState.cameraTouchId) {
          touchStillExists = true;
          break;
        }
      }
      
      if (!touchStillExists) {
        controlState.cameraTouchId = null;
        lastTouchX = null;
        lastTouchY = null;
      }
      
      e.preventDefault();
    });

    renderer.domElement.addEventListener('touchcancel', (e) => {
      controlState.cameraTouchId = null;
      lastTouchX = null;
      lastTouchY = null;
      e.preventDefault();
    });

    // --- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —É–∫–∞–∑–∞—Ç–µ–ª—è –¥–ª—è –ü–ö ---
    renderer.domElement.addEventListener('click', () => {
      renderer.domElement.requestPointerLock();
    });

    // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –º—ã—à–∏ –¥–ª—è –ü–ö ---
    document.addEventListener('mousemove', (e) => {
      if (document.pointerLockElement === renderer.domElement) {
        yaw -= e.movementX * 0.002;
        pitch -= e.movementY * 0.002;
        pitch = Math.max(-Math.PI/2, Math.min(Math.PI/2, pitch));
        camera.rotation.order = 'YXZ';
        camera.rotation.set(pitch, yaw, 0);
      }
    });

    // --- –°–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è ---
    const moveSpeed = 0.5;

    // --- –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã ---
    function updateCamera() {
      const direction = new THREE.Vector3(0, 0, -1);
      direction.applyEuler(camera.rotation);
      
      const horizontalDir = direction.clone();
      horizontalDir.y = 0;
      horizontalDir.normalize();
      
      const right = new THREE.Vector3(1, 0, 0);
      right.applyEuler(camera.rotation);
      right.y = 0;
      right.normalize();
      
      // –î–≤–∏–∂–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–ü–ö)
      if (controlState.w) camera.position.addScaledVector(horizontalDir, moveSpeed);
      if (controlState.s) camera.position.addScaledVector(horizontalDir, -moveSpeed);
      if (controlState.d) camera.position.addScaledVector(right, moveSpeed);
      if (controlState.a) camera.position.addScaledVector(right, -moveSpeed);
      
      // –î–≤–∏–∂–µ–Ω–∏–µ —Å –¥–∂–æ–π—Å—Ç–∏–∫–∞ (–º–æ–±–∏–ª—å–Ω—ã–µ)
      if (controlState.moveForward !== 0) {
        camera.position.addScaledVector(horizontalDir, controlState.moveForward * moveSpeed);
      }
      if (controlState.moveRight !== 0) {
        camera.position.addScaledVector(right, controlState.moveRight * moveSpeed);
      }
      
      // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ (–∫–ª–∞–≤–∏—à–∏)
      if (controlState.q || controlState.shift) camera.position.y -= moveSpeed;
      if (controlState.e || controlState.space) camera.position.y += moveSpeed;
      
      // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ (–º–æ–±–∏–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏)
      if (controlState.flyDown) camera.position.y -= moveSpeed;
      if (controlState.flyUp) camera.position.y += moveSpeed;
    }

    // --- –†–µ–µ—Å—Ç—Ä —Å —Ç–µ–∫—Å—Ç—É—Ä–∞–º–∏ ---
    const RegistryData = {
      Block: {},
      Item: {},
      Entity: {},
      Other: {}
    };

    function Registry(category, options) {
      if (!RegistryData[category]) {
        console.warn("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è:", category);
        return;
      }

      const faces = {};
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—Å—Ç—É—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã
      if (options.textures) {
        for (let side of ["top", "bottom", "left", "right", "front", "back"]) {
          if (options.textures[side]) {
            try {
              let tex = loader.load(`textures/${options.textures[side]}`);
              tex.magFilter = THREE.NearestFilter;
              tex.minFilter = THREE.NearestFilter;
              tex.generateMipmaps = false;
              faces[side] = tex;
            } catch (e) {
              console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç—É—Ä—É ${options.textures[side]}`);
              faces[side] = null;
            }
          } else {
            faces[side] = null;
          }
        }
      }

      RegistryData[category][options.id] = { ...options, textures: faces };
    }

    const loader = new THREE.TextureLoader();

    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –±–ª–æ–∫–∏ —Å —Ç–µ–∫—Å—Ç—É—Ä–∞–º–∏
    Registry("Block", {
      id: "stone",
      textures: { 
        top: "top.png", 
        bottom: "top.png", 
        left: "top.png", 
        right: "top.png", 
        front: "top.png", 
        back: "top.png" 
      },
      hardness: 5
    });

    Registry("Block", {
      id: "grass",
      textures: { 
        top: "top.png", 
        bottom: "top.png", 
        left: "top.png", 
        right: "top.png", 
        front: "grass_side.png", 
        back: "grass_side.png" 
      },
      hardness: 2
    });

    Registry("Block", {
      id: "dirt",
      textures: { 
        top: "dirt.png", 
        bottom: "dirt.png", 
        left: "dirt.png", 
        right: "dirt.png", 
        front: "dirt.png", 
        back: "dirt.png" 
      },
      hardness: 1
    });

    // --- –ö–ª–∞—Å—Å –±–ª–æ–∫–∞ ---
    class Block {
      constructor(type, x, y, z) {
        this.type = type;
        this.data = {};
        this.mesh = this.createMesh();
        this.mesh.position.set(x, y, z);
      }

      createMesh() {
        const reg = RegistryData.Block[this.type];
        if (!reg) return new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshBasicMaterial({visible:false}));

        // –°–æ–∑–¥–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã
        const materials = [
          new THREE.MeshBasicMaterial({ map: reg.textures.right || null }), // right
          new THREE.MeshBasicMaterial({ map: reg.textures.left || null }),  // left
          new THREE.MeshBasicMaterial({ map: reg.textures.top || null }),   // top
          new THREE.MeshBasicMaterial({ map: reg.textures.bottom || null }),// bottom
          new THREE.MeshBasicMaterial({ map: reg.textures.front || null }), // front
          new THREE.MeshBasicMaterial({ map: reg.textures.back || null })   // back
        ];

        return new THREE.Mesh(new THREE.BoxGeometry(1,1,1), materials);
      }
    }

    // --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏—Ä–∞ ---
    const sizeX = 10, sizeY = 5, sizeZ = 10;
    let world = [];

    for (let x = 0; x < sizeX; x++) {
      world[x] = [];
      for (let y = 0; y < sizeY; y++) {
        world[x][y] = [];
        for (let z = 0; z < sizeZ; z++) {
          let types = ["stone", "grass", "dirt"];
          let type = types[Math.floor(Math.random() * types.length)];
          let block = new Block(type, x, y, z);
          world[x][y][z] = block;
          scene.add(block.mesh);
        }
      }
    }

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–µ—Ç
    const ambientLight = new THREE.AmbientLight(0x404060);
    scene.add(ambientLight);
    
    const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
    directionalLight.position.set(10, 20, 10);
    scene.add(directionalLight);

    // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∞
    function render() {
      requestAnimationFrame(render);
      
      updateCamera();
      
      renderer.render(scene, camera);
    }
    render();

    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    console.log("–ú–∏—Ä –∑–∞–≥—Ä—É–∂–µ–Ω, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–µ —Ä—É–∫–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ!");
  </script>
</body>
</html>
